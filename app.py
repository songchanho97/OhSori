# ë‰´ìŠ¤ API ì—†ìœ¼ë¯€ë¡œ ë‰´ìŠ¤ ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì„ì‹œ
content = """
ë‰´ìŠ¤1 :
êµ­ë¯¼ì˜í˜ì´ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ â€œë¶í•œì— ì ëŒ€í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤â€ê³  ë°íŒ ê²ƒì— ëŒ€í•´ â€œí˜„ì‹¤ì„ ì™¸ë©´í•œ í•œê°€í•œ ì†Œë¦¬â€ë¼ë©° ê°•í•˜ê²Œ ë¹„íŒí–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ â€œë¶í•œì´ â€˜í—ˆë§í•œ ê°œê¿ˆâ€™ì´ë¼ê³  ì¡°ë¡±í•˜ëŠ” ìƒí™©ì—ì„œë„ ëê¹Œì§€ í™”ë‹µì„ ê¸°ëŒ€í•˜ê² ë‹¤ëŠ” ê²ƒì€ ë¶í•œì— ëŒ€í•œ ë¬´í•œ ì¸ë‚´ê°€ ì•„ë‹ˆë¼ êµ­ë¯¼ì˜ ì¸ë‚´ì‹¬ì„ ì‹œí—˜í•˜ëŠ” ì¼â€ì´ë¼ë©° ì´ê°™ì´ ë°í˜”ë‹¤.
ìµœ ìˆ˜ì„ ëŒ€ë³€ì¸ì€ â€œêµ­ë¯¼ì´ ì •ì‘ ë“£ê³  ì‹¶ì–´í–ˆë˜ ê²ƒì€ ë¶í•œì˜ í•µÂ·ë¯¸ì‚¬ì¼ ìœ„í˜‘ê³¼ ë„ë°œì— ëŒ€í•œ ë‹¨í˜¸í•œ ê²½ê³ , ê·¸ë¦¬ê³  ê·¸ì— ë§ì„¤ ê°•ë ¥í•œ ì–µì§€ë ¥ ê°•í™” ë°©ì•ˆì´ì—ˆë‹¤â€ë©° â€œëŒ€í†µë ¹ ì·¨ì„ ì´í›„ ì´ ì •ë¶€ê°€ ê±¸ì–´ì˜¨ ëŒ€ë¶ í–‰ë³´ëŠ” ëŒ€ë¶ ì „ë‹¨ ë‹¨ì†, ëŒ€ë¶ í™•ì„±ê¸° ë°©ì†¡ ì¤‘ë‹¨, í™•ì„±ê¸° ì² ê±°, í•œë¯¸ì—°í•©í›ˆë ¨ ì¡°ì •, ë¶í•œ ì¸ê¶Œë³´ê³ ì„œ ë°œê°„ ì¤‘ë‹¨ ê²€í† ê¹Œì§€ ì˜¨í†µ ë¶í•œ ê¹€ì •ì€ì´ ì›ƒì„ ì¼ë§Œ ì´ì–´ì¡Œë‹¤â€ê³  í–ˆë‹¤.
ê·¸ëŠ” â€œ9Â·19 êµ°ì‚¬í•©ì˜ëŠ” ë¬¸ì¬ì¸ ì •ë¶€ ë‹¹ì‹œì—ë„ ë¶í•œì´ ë°¥ ë¨¹ë“¯ì´ ìœ„ë°˜í•˜ë©° ì‚¬ì‹¤ìƒ ë¬´ë ¥í™”ëì—ˆëŠ”ë° ì´ë¥¼ ë‹¤ì‹œ ë³µì›í•˜ê² ë‹¤ëŠ” ê²ƒì€ ì´ë¯¸ ì‹¤íŒ¨ë¡œ ì¦ëª…ëœ ì¡±ì‡„ë¥¼ ìš°ë¦¬ ìŠ¤ìŠ¤ë¡œ ë°œëª©ì— ì±„ìš°ê² ë‹¤ëŠ” ê²ƒâ€ì´ë¼ë©° â€œí‰í™”ëŠ” í˜ì´ ìˆì„ ë•Œë§Œ ê°€ëŠ¥í•˜ë‹¤ëŠ” ìƒì‹ì„ ì´ ì •ë¶€ë§Œ ëª¨ë¥´ëŠ” ê²ƒì´ëƒ ì•„ë‹ˆë©´ ì•Œê³ ë„ ì™¸ë©´í•˜ëŠ” ê²ƒì´ëƒâ€ë¼ê³  ë§í–ˆë‹¤.
ê¹€ë¬¸ìˆ˜ êµ­ë¯¼ì˜í˜ ë‹¹ëŒ€í‘œ í›„ë³´ë„ í˜ì´ìŠ¤ë¶ì—ì„œ â€œì´ì¬ëª… ëŒ€í†µë ¹ì€ ì§€ê¸ˆ ë¶í•µ ìœ„í—˜, ì˜¤ë¬¼ í’ì„  ì‚´í¬, ëŠì„ì—†ëŠ” ë¬´ë ¥ ë„ë°œì— ë§ì„œì•¼ í•  ì‹œì ì— ë¶í•œ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì ëŒ€ í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤ëŠ” êµ´ë³µ ì„ ì–¸ì„ í–ˆë‹¤â€ë©° â€œ9Â·19 êµ°ì‚¬í•©ì˜ë¥¼ ë¨¼ì € ê¹¬ ìª½ë„ ë¶í•œì¸ë° ì™œ ìš°ë¦¬ê°€ ë¶í•œì— ê³ ê°œë¥¼ ìˆ™ì—¬ì•¼ í•˜ë‚˜â€ë¼ê³  ë¹„íŒí–ˆë‹¤.
ê·¸ëŠ” â€œê¹€ì •ì€ì˜ ëŒ€ë³€ì¸ì´ ì•„ë‹ˆë¼ë©´ ê²°ì½” ë‚˜ì˜¬ ìˆ˜ ì—†ëŠ” ë°œì–¸â€ì´ë¼ë©° â€œëŒ€í†µë ¹ì˜ ìë¦¬ëŠ” ê¹€ì •ì€ì˜ ì‹¬ê¸°ë¥¼ ì‚´í”¼ëŠ” ìë¦¬ê°€ ì•„ë‹ˆë¼ ì˜¤ì§ ëŒ€í•œë¯¼êµ­ì˜ ì•ˆìœ„ë¥¼ ì§€í‚¤ê¸° ìœ„í•´ ìµœì„ ì„ ë‹¤í•´ì•¼ í•˜ëŠ” ìë¦¬â€ë¼ê³  ë§í–ˆë‹¤.
ì´ ëŒ€í†µë ¹ì€ ì§€ë‚œ 15ì¼ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ â€œí˜„ì¬ ë¶ì¸¡ì˜ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì–´ë– í•œ í˜•íƒœì˜ í¡ìˆ˜í†µì¼ë„ ì¶”êµ¬í•˜ì§€ ì•Šì„ ê²ƒì´ë©° ì¼ì²´ì˜ ì ëŒ€í–‰ìœ„ë¥¼ í•  ëœ»ë„ ì—†ìŒì„ ë¶„ëª…íˆ ë°íŒë‹¤â€ê³  ë§í–ˆë‹¤.
---
ë‰´ìŠ¤2 :
êµ­ë¯¼ì˜í˜ì€ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ êµ­ë¯¼ì„ëª…ì‹ì—ì„œ ë‚­ë…í•œ â€˜êµ­ë¯¼ê»˜ ë“œë¦¬ëŠ” í¸ì§€â€™ì— ëŒ€í•´ â€œêµ­ë¯¼ì„ í˜„í˜¹í•˜ëŠ” ë§ë¡œ ì ì² ëœ ê±°ì§“ë§ì˜ í–¥ì—°â€ì´ë¼ê³  í˜¹í‰í–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì„ í†µí•´ â€œì´ ëŒ€í†µë ¹ì´ ì´ì•¼ê¸°í•˜ëŠ” êµ­ë¯¼ì€ ë„ëŒ€ì²´ ëˆ„êµ¬ë¥¼ ë§í•˜ëŠ” ê²ƒì´ëƒâ€ë¼ë©° ì´ê°™ì´ ë°í˜”ë‹¤.
ìµœ ëŒ€ë³€ì¸ì€ â€œì´ ëŒ€í†µë ¹ì€ ê¸°ì—…ì´ ììœ ë¡­ê²Œ ì„±ì¥í•˜ê³  ì„¸ê³„ ì‹œì¥ì—ì„œ ê²½ìŸí•  ìˆ˜ ìˆë„ë¡ ë•ê² ë‹¤ í–ˆì§€ë§Œ, ê¸°ì—…ë“¤ì€ ë¯¸êµ­ë°œ ê´€ì„¸ í­íƒ„ê³¼ ìƒë²• ê°œì•… ë“± â€˜ê¸°ì—… ì˜¥ì£„ê¸°â€™ ì •ì±…ì— ê²½ì˜ í™˜ê²½ì´ ê°ˆìˆ˜ë¡ ì–´ë ¤ì›Œì§€ê³  ìˆë‹¤ê³  í˜¸ì†Œí•œë‹¤â€ê³  ì£¼ì¥í–ˆë‹¤.
ê·¸ëŠ” ì´ì–´ â€˜ê³¼í•™ ê¸°ìˆ ì¸ ì§€ì›â€™ ì•½ì†ì— ëŒ€í•´ì„  â€œ(ë°˜ë„ì²´ íŠ¹ë³„ë²•) 52ì‹œê°„ ê´€ë ¨ ë²•ì•ˆì„ ì´ ëŒ€í†µë ¹ê³¼ ë¯¼ì£¼ë‹¹ì´ ê²°ì‚¬ë°˜ëŒ€í–ˆë˜ ëª¨ìŠµë§Œ ë´ë„ ì´ëŠ” í—ˆêµ¬ì— ê°€ë“ ì°¬ ê±°ì§“ë§â€ì´ë¼ê³  ë¹„íŒí–ˆë‹¤.
ê·¸ëŸ¬ë©´ì„œ â€œì¡°êµ­ê³¼ ìœ¤ë¯¸í–¥ ì‚¬ë©´ì„ ê°•í–‰í•˜ê³  ëŒ€í†µë ¹ ë³€í˜¸ì¸ë‹¨ì„ â€˜ì²­ë¬¸íšŒ ì—†ëŠ” ìš”ì§â€™ì— ì•‰íˆëŠ” ë“± êµ­ë¯¼ì´ ì•„ë‹Œ ì˜¤ì§ ìš°ë¦¬ í¸ë§Œì„ ì±™ê¸°ëŠ” ì§„ì˜ì˜ ëŒ€ë³€ìê°€ ë” ì–´ìš¸ë¦¬ëŠ” í‘œí˜„ì¼ ê²ƒâ€ì´ë¼ê³  ë§ë¶™ì˜€ë‹¤.
í˜¸ì¤€ì„ ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ ì´ ëŒ€í†µë ¹ì´ ë¯¸êµ­ ë°©ë¬¸ì— ì•ì„œ ì¼ë³¸ì„ ì°¾ì•„ í•œÂ·ì¼ ì •ìƒíšŒë‹´ì„ í•˜ëŠ” ê²ƒì„ ë‘ê³  â€œ2023ë…„ ì…”í‹€ ì™¸êµê°€ ë³µì›ë˜ì ì´ì¬ëª… ë‹¹ì‹œ ë¯¼ì£¼ë‹¹ ëŒ€í‘œëŠ” â€˜ì¹œì¼ì„ ë„˜ì–´ ìˆ­ì¼â€™ì´ë¼ê³  ëª°ì•„ì„¸ì› ë‹¤â€ë©° â€œêµ­ê°€ì˜ ì§€ë„ìë¼ë©´ ë¶ˆê³¼ 2ë…„ì „ ìê¸° ë§ê³¼ í–‰ë™ì— ëŒ€í•´ ì±…ì„ì§€ê³  ìœ ê° í‘œëª…ì´ë¼ë„ í•´ì•¼ í•œë‹¤â€ê³  ë§í–ˆë‹¤.
---
ë‰´ìŠ¤3 :
êµ­ë¯¼ì˜í˜ì€ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ ë¶í•œì„ ë¶ì¸¡ì´ë¼ê³  ë¶€ë¥´ë©° â€œëŒ€í™”ë¥¼ ë³µì›í•˜ëŠ” ê¸¸ì— ë¶ì¸¡ì´ í™”ë‹µí•˜ê¸¸ ì¸ë‚´í•˜ë©´ì„œ ê¸°ëŒ€í•˜ê² ë‹¤â€ê³  ì–¸ê¸‰í•œ ê²ƒì— ëŒ€í•´ â€œë¶í•œì— ëŒ€í•œ ë¬´í•œ ì¸ë‚´ê°€ ì•„ë‹ˆë¼ êµ­ë¯¼ ì¸ë‚´ì‹¬ì„ ì‹œí—˜í•˜ê³  ìˆë‹¤â€ê³  ë¹„íŒí–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ â€œëŒ€í†µë ¹ ì·¨ì„ ì´í›„ ì´ ì •ë¶€ê°€ ê±¸ì–´ì˜¨ ëŒ€ë¶ í–‰ë³´ë¥¼ ë³´ë©´ ì˜¨í†µ ë¶í•œ ê¹€ì •ì€ì´ ì›ƒì„ ì¼ë§Œ ì´ì–´ì¡Œë‹¤â€ë©° â€œë¶í•œì´ â€˜í—ˆë§í•œ ê°œê¿ˆâ€™ì´ë¼ ì¡°ë¡±í•˜ëŠ” ìƒí™©ì—ì„œë„ ëê¹Œì§€ í™”ë‹µì„ ê¸°ëŒ€í•œë‹¤ê³  í•œë‹¤â€ê³  ì§€ì í–ˆë‹¤.
ì´ì–´ ì´ ëŒ€í†µë ¹ì´ ë¶í•œì— â€œì¼ì²´ì˜ ì ëŒ€í–‰ìœ„ë¥¼ í•  ëœ»ì´ ì—†ë‹¤â€ê³  ë§í•œ ê²ƒê³¼ ê´€ë ¨ â€œë¨¸ë¦¬ì— í•µì„ ì¸ ì±„ â€˜ì ëŒ€ í–‰ìœ„ëŠ” í•˜ì§€ ì•Šê² ë‹¤â€™ëŠ” ì„ ì–¸ì€ í˜„ì‹¤ì„ ì™¸ë©´í•œ í•œê°€í•œ ì†Œë¦¬ì¼ ë¿â€ì´ë¼ê³  ë§í–ˆë‹¤.
ë˜ â€œêµ­ë¯¼ì´ ì •ì‘ ë“£ê³  ì‹¶ì–´ í–ˆë˜ ê²ƒì€ ë¶í•œì˜ í•µÂ·ë¯¸ì‚¬ì¼ ìœ„í˜‘ê³¼ ë„ë°œì— ëŒ€í•œ ë‹¨í˜¸í•œ ê²½ê³ ì™€ ê·¸ì— ë§ì„¤ ê°•ë ¥í•œ ì–µì§€ë ¥ ê°•í™” ë°©ì•ˆì´ë‹¤. í‰í™”ëŠ” êµ¬ê±¸ì´ ì•„ë‹ˆë¼ ê°•í•œ ì–µì§€ë ¥ì—ì„œ ë‚˜ì˜¨ë‹¤â€ê³  ê°•ì¡°í–ˆë‹¤.
ìµœ ìˆ˜ì„ëŒ€ë³€ì¸ì€ â€œ9Â·19 êµ°ì‚¬í•©ì˜ë¥¼ ë‹¤ì‹œ ë³µì›í•˜ê² ë‹¤ëŠ” ê²ƒì€ ì´ë¯¸ ì‹¤íŒ¨ë¡œ ì¦ëª…ëœ ì¡±ì‡„ë¥¼ ìš°ë¦¬ ìŠ¤ìŠ¤ë¡œ ë°œëª©ì— ì±„ìš°ê² ë‹¤ëŠ” ê²ƒìœ¼ë¡œ, ìë©¸ë¡œ ê°€ëŠ” ê¸¸â€ì´ë¼ê³  ë§í–ˆë‹¤.
ë‹¹ ëŒ€í‘œ í›„ë³´ì¸ ê¹€ë¬¸ìˆ˜ í›„ë³´ë„ ì…ì¥ë¬¸ì„ í†µí•´ â€œì´ ëŒ€í†µë ¹ì´ ë¶í•œ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì ëŒ€ í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤ëŠ” êµ´ë³µ ì„ ì–¸ì„ í–ˆë‹¤â€ë©° â€œê¹€ì •ì€ì˜ ëŒ€ë³€ì¸ì´ ì•„ë‹ˆë¼ë©´ ê²°ì½” ë‚˜ì˜¬ ìˆ˜ ì—†ëŠ” ë°œì–¸â€ì´ë¼ê³  ë¹„íŒí–ˆë‹¤.
"""


import streamlit as st
from langchain_openai import ChatOpenAI
from dotenv import load_dotenv
import os
import io

# core.pyì—ì„œ ëª¨ë“  í•¨ìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
from core import (
    clean_text_for_tts,
    run_host_agent,
    run_guest_agents,
    run_writer_agent,
    parse_script,
    assign_voices,
    generate_audio_segments,
    process_podcast_audio,
    get_speech_style_for_mood,
    change_audio_speed,
)

load_dotenv(dotenv_path=".env")
LANGSMITH_API_KEY = os.getenv("LANGSMITH_API_KEY")

# --- UI ì„¹ì…˜ ---
st.title("ğŸ¤ AI ë‰´ìŠ¤ íŒŸìºìŠ¤íŠ¸ ìŠ¤íŠœë””ì˜¤")
st.markdown(
    "ê´€ì‹¬ ìˆëŠ” ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê³ , AIê°€ ìë™ìœ¼ë¡œ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì—¬ íŒŸìºìŠ¤íŠ¸ ìŒì„±ê¹Œì§€ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤."
)

# --- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ---
if "script" not in st.session_state:
    st.session_state.script = ""
if "podcast_mood" not in st.session_state:
    st.session_state.podcast_mood = "ì°¨ë¶„í•œ"
if "podcast_mode" not in st.session_state:
    st.session_state.podcast_mode = "íŒ©íŠ¸ ë¸Œë¦¬í•‘"
if "selected_category" not in st.session_state:
    st.session_state.selected_category = "ì „ì²´"
if "selected_language" not in st.session_state:
    st.session_state.selected_language = "í•œêµ­ì–´"

# --- 1. ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì„¹ì…˜ (ë³µêµ¬) ---
st.subheader("1. ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ")
category_options = {
    "ì „ì²´": "ğŸŒ ì „ì²´",
    "ê²½ì œ": "ğŸ“ˆ ê²½ì œ",
    "IT": "ğŸ’» IT/ê³¼í•™",
    "ì •ì¹˜": "ğŸ›ï¸ ì •ì¹˜",
    "ì‚¬íšŒ": "ğŸ‘¥ ì‚¬íšŒ",
    "ìƒí™œ/ë¬¸í™”": "ğŸ¨ ìƒí™œ/ë¬¸í™”",
    "ìŠ¤í¬ì¸ ": "âš½ ìŠ¤í¬ì¸ ",
    "ì„¸ê³„": "ğŸŒ ì„¸ê³„",
}
num_cols_per_row = 4
cols_cat = st.columns(num_cols_per_row)
col_idx = 0
for i, (cat_key, cat_label) in enumerate(category_options.items()):
    with cols_cat[col_idx]:
        if st.button(
            cat_label,
            key=f"cat_{cat_key}",
            use_container_width=True,
            type=(
                "primary"
                if st.session_state.selected_category == cat_key
                else "secondary"
            ),
        ):
            if st.session_state.selected_category != cat_key:
                st.session_state.selected_category = cat_key
                st.rerun()
    col_idx = (col_idx + 1) % num_cols_per_row

# --- 2. ë‰´ìŠ¤ ê²€ìƒ‰ ì¡°ê±´ ì…ë ¥ ì„¹ì…˜ ---
st.subheader("2. ë‰´ìŠ¤ ê²€ìƒ‰ ì¡°ê±´ ì…ë ¥")
query = st.text_input(
    "ê²€ìƒ‰í•  ë‰´ìŠ¤ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”", placeholder="ì˜ˆ: 'ì±—GPT', 'ê²½ì œ ì¹¨ì²´'"
)

# --- 3. íŒŸìºìŠ¤íŠ¸ ë¶„ìœ„ê¸° ì„ íƒ ì„¹ì…˜ ---
st.subheader("3. íŒŸìºìŠ¤íŠ¸ ë¶„ìœ„ê¸° ì„ íƒ")
mood_options = {
    "ì°¨ë¶„í•œ": "ğŸ§˜â€â™€ï¸ ì°¨ë¶„í•œ",
    "ì‹ ë‚˜ëŠ”": "ğŸ¥³ ì‹ ë‚˜ëŠ”",
    "ì „ë¬¸ì ì¸": "ğŸ‘¨â€ğŸ« ì „ë¬¸ì ì¸",
    "ìœ ë¨¸ëŸ¬ìŠ¤í•œ": "ğŸ˜‚ ìœ ë¨¸ëŸ¬ìŠ¤í•œ",
}
cols_mood = st.columns(len(mood_options))
for i, (mood_key, mood_label) in enumerate(mood_options.items()):
    with cols_mood[i]:
        if st.button(
            mood_label,
            key=f"mood_{mood_key}",
            use_container_width=True,
            type=(
                "primary" if st.session_state.podcast_mood == mood_key else "secondary"
            ),
        ):
            if st.session_state.podcast_mood != mood_key:
                st.session_state.podcast_mood = mood_key
                st.rerun()


# --- 4. íŒŸìºìŠ¤íŠ¸ ëª¨ë“œ ì„ íƒ ì„¹ì…˜ ---
st.subheader("4. íŒŸìºìŠ¤íŠ¸ ëª¨ë“œ ì„ íƒ")
mode_options = {"íŒ©íŠ¸ ë¸Œë¦¬í•‘": "íŒ©íŠ¸ ë¸Œë¦¬í•‘", "ê· í˜• í† ì˜": "ê· í˜• í† ì˜"}
cols_mode = st.columns(len(mode_options))
for i, (mode_key, mode_label) in enumerate(mode_options.items()):
    with cols_mode[i]:
        if st.button(
            mode_label,
            key=f"mode_{mode_key}",
            use_container_width=True,
            type=(
                "primary" if st.session_state.podcast_mode == mode_key else "secondary"
            ),
        ):
            if st.session_state.podcast_mode != mode_key:
                st.session_state.podcast_mode = mode_key
                st.rerun()


# --- 5. íŒŸìºìŠ¤íŠ¸ ì–¸ì–´ ì„ íƒ ì„¹ì…˜ ---
st.subheader("5. íŒŸìºìŠ¤íŠ¸ ì–¸ì–´ ì„ íƒ")
# 'ì¤‘êµ­ì–´'ë¥¼ 'ì¼ë³¸ì–´'ë¡œ ë³€ê²½í•˜ê³  emoji ì¶”ê°€
language_options = {
    "í•œêµ­ì–´": "ğŸ‡°ğŸ‡· í•œêµ­ì–´",
    "ì˜ì–´": "ğŸ‡ºğŸ‡¸ ì˜ì–´",
    "ì¼ë³¸ì–´": "ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´",
    "ì¤‘êµ­ì–´": "ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´",
}

lang_cols = st.columns(len(language_options))

for i, (lang_key, lang_label) in enumerate(language_options.items()):
    with lang_cols[i]:
        button_type = (
            "primary" if st.session_state.selected_language == lang_key else "secondary"
        )
        if st.button(
            lang_label,
            key=f"lang_btn_{lang_key}",  # í‚¤ ê°’ì„ ë‹¤ë¥¸ ì„¹ì…˜ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ìˆ˜ì •
            use_container_width=True,
            type=button_type,
        ):
            # ìƒíƒœê°€ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ rerunì„ í˜¸ì¶œí•©ë‹ˆë‹¤. (ì´ ë¶€ë¶„ì´ í•µì‹¬!)
            if st.session_state.selected_language != lang_key:
                st.session_state.selected_language = lang_key
                st.rerun()


# app.pyì—ì„œ ìˆ˜ì •í•  ë¶€ë¶„


# ì„¸ì…˜ ìƒíƒœì— 'selected_speed'ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°ê°’ìœ¼ë¡œ '1.0x'ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
if "selected_speed" not in st.session_state:
    st.session_state.selected_speed = "1.0x"


# --- 5. ëŒ€ë³¸ ìƒì„± ë²„íŠ¼ ì„¹ì…˜ ---
st.subheader("6. íŒŸìºìŠ¤íŠ¸ ìƒì„±")

if st.button("âœ¨ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸ ìƒì„±í•˜ê¸°", use_container_width=True, type="primary"):
    if not query:
        st.error("ë‰´ìŠ¤ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        try:
            llm = ChatOpenAI(model_name="gpt-4o", temperature=0.7)

            with st.spinner("1/3: Host-Agentê°€ ê²ŒìŠ¤íŠ¸ë¥¼ ì„­ì™¸í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                host_response = run_host_agent(
                    llm, query, content, st.session_state.podcast_mode
                )
            with st.spinner("2/3: Guest-Agentsê°€ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
                guest_answers = run_guest_agents(
                    llm,
                    query,
                    host_response["guests"],
                    host_response["interview_outline"],
                    content,
                    st.session_state.podcast_mode,
                )
            with st.spinner("3/3: Writer-Agentê°€ ëŒ€ë³¸ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):

                final_script = run_writer_agent(
                    llm,
                    query,
                    st.session_state.podcast_mood,
                    st.session_state.selected_language,
                    host_response["guests"],
                    guest_answers,
                )
                st.session_state.script = final_script
        except Exception as e:
            st.error(f"ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜: {e}")

# app.pyì—ì„œ ìˆ˜ì •í•  ë¶€ë¶„

# --- 6. ìŒì„± ìƒì„± ì„¹ì…˜ ---
# ì´ ì¡°ê±´ë¬¸ì´ 'ëŒ€ë³¸ì´ ìˆì„ ë•Œë§Œ' ì•„ë˜ ë‚´ìš©ì„ í‘œì‹œí•˜ë„ë¡ í•©ë‹ˆë‹¤.
if st.session_state.script:
    st.subheader("ğŸ‰ ìƒì„±ëœ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸")
    st.text_area("ëŒ€ë³¸", st.session_state.script, height=300)

    # ì´ ë²„íŠ¼ê³¼ ì•„ë˜ì˜ ëª¨ë“  ë¡œì§ì´ if ì¡°ê±´ë¬¸ ì•ˆì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    if st.button(
        "ğŸ§ ì´ ëŒ€ë³¸ìœ¼ë¡œ ìŒì„± ìƒì„±í•˜ê¸°", use_container_width=True, type="primary"
    ):
        with st.spinner(
            "ìŒì„±ì„ ìƒì„±í•˜ê³  BGMì„ í¸ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."
        ):
            try:
                # 1. ìŠ¤í¬ë¦½íŠ¸ íŒŒì‹±
                # core.pyì— ì¶”ê°€í•œ normalize_speaker_names í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ë” ì¢‹ìŠµë‹ˆë‹¤.
                # ì˜ˆ: parsed_lines, speakers = normalize_speaker_names(st.session_state.script)
                parsed_lines, speakers = parse_script(st.session_state.script)

                if not speakers:
                    st.error(
                        "ëŒ€ë³¸ì—ì„œ í™”ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ë³¸ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì˜ˆ: **ì´ë¦„:**)"
                    )
                else:
                    # 2. ëª©ì†Œë¦¬ ë°°ì •
                    voice_map = assign_voices(
                        speakers, st.session_state.selected_language
                    )
                    st.write("#### ğŸ¤ ëª©ì†Œë¦¬ ë°°ì • ê²°ê³¼")
                    for speaker, voice in voice_map.items():
                        st.write(f"**{speaker}** â†’ **{voice}**")

                    # 3. ëª¨ë“  ëŒ€ì‚¬ì— ëŒ€í•œ ìŒì„± ì¡°ê° ìƒì„±
                    st.write("#### ğŸ§ ìŒì„± ì¡°ê° ìƒì„± ì¤‘...")
                    audio_segments = generate_audio_segments(
                        parsed_lines, voice_map, st.session_state.podcast_mood
                    )
                    st.write(f"ì´ {len(audio_segments)}ê°œì˜ ìŒì„± ì¡°ê°ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.")

                    # 4. BGMê³¼ í•¨ê»˜ ìµœì¢… íŒŸìºìŠ¤íŠ¸ ì˜¤ë””ì˜¤ ì²˜ë¦¬
                    st.write("#### ğŸ¶ BGM í¸ì§‘ ë° ìµœì¢… ê²°í•© ì¤‘...")
                    # process_podcast_audio í•¨ìˆ˜ê°€ AudioSegmentë¥¼ ë°˜í™˜í•˜ë„ë¡ core.pyì—ì„œ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
                    final_podcast_audio_segment = process_podcast_audio(
                        audio_segments, "mp3.mp3"
                    )

                    # 5. ì¬ìƒ ì†ë„ ì ìš©
                    # core.pyì— change_audio_speed í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ê³  ë¶ˆëŸ¬ì™€ì•¼ í•©ë‹ˆë‹¤.
                    speed_factor = float(
                        st.session_state.selected_speed.replace("x", "")
                    )
                    if speed_factor != 1.0:
                        final_podcast_audio_segment = change_audio_speed(
                            final_podcast_audio_segment, speed_factor
                        )

                    # 6. ìµœì¢… ì˜¤ë””ì˜¤ë¥¼ ë©”ëª¨ë¦¬ë¡œ ë‚´ë³´ë‚´ê¸°
                    final_podcast_io = io.BytesIO()
                    final_podcast_audio_segment.export(
                        final_podcast_io, format="mp3", bitrate="192k"
                    )
                    final_podcast_io.seek(0)

                    # 7. ê²°ê³¼ ì¶œë ¥
                    st.success("ğŸ‰ íŒŸìºìŠ¤íŠ¸ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                    st.audio(final_podcast_io, format="audio/mp3")
                    st.download_button(
                        label="ğŸ“¥ MP3 íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                        data=final_podcast_io,
                        file_name="podcast_with_intro.mp3",
                        mime="audio/mpeg",
                    )
            except Exception as e:
                st.error(f"ìŒì„± ìƒì„± ë˜ëŠ” í›„ë°˜ ì‘ì—… ì¤‘ ì˜¤ë¥˜: {e}")
