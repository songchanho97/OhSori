# ë‰´ìŠ¤ API ì—†ìœ¼ë¯€ë¡œ ë‰´ìŠ¤ ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì„ì‹œ
content = """
ë‰´ìŠ¤1 : 
êµ­ë¯¼ì˜í˜ì´ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ â€œë¶í•œì— ì ëŒ€í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤â€ê³  ë°íŒ ê²ƒì— ëŒ€í•´ â€œí˜„ì‹¤ì„ ì™¸ë©´í•œ í•œê°€í•œ ì†Œë¦¬â€ë¼ë©° ê°•í•˜ê²Œ ë¹„íŒí–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ â€œë¶í•œì´ â€˜í—ˆë§í•œ ê°œê¿ˆâ€™ì´ë¼ê³  ì¡°ë¡±í•˜ëŠ” ìƒí™©ì—ì„œë„ ëê¹Œì§€ í™”ë‹µì„ ê¸°ëŒ€í•˜ê² ë‹¤ëŠ” ê²ƒì€ ë¶í•œì— ëŒ€í•œ ë¬´í•œ ì¸ë‚´ê°€ ì•„ë‹ˆë¼ êµ­ë¯¼ì˜ ì¸ë‚´ì‹¬ì„ ì‹œí—˜í•˜ëŠ” ì¼â€ì´ë¼ë©° ì´ê°™ì´ ë°í˜”ë‹¤.
ìµœ ìˆ˜ì„ ëŒ€ë³€ì¸ì€ â€œêµ­ë¯¼ì´ ì •ì‘ ë“£ê³  ì‹¶ì–´í–ˆë˜ ê²ƒì€ ë¶í•œì˜ í•µÂ·ë¯¸ì‚¬ì¼ ìœ„í˜‘ê³¼ ë„ë°œì— ëŒ€í•œ ë‹¨í˜¸í•œ ê²½ê³ , ê·¸ë¦¬ê³  ê·¸ì— ë§ì„¤ ê°•ë ¥í•œ ì–µì§€ë ¥ ê°•í™” ë°©ì•ˆì´ì—ˆë‹¤â€ë©° â€œëŒ€í†µë ¹ ì·¨ì„ ì´í›„ ì´ ì •ë¶€ê°€ ê±¸ì–´ì˜¨ ëŒ€ë¶ í–‰ë³´ëŠ” ëŒ€ë¶ ì „ë‹¨ ë‹¨ì†, ëŒ€ë¶ í™•ì„±ê¸° ë°©ì†¡ ì¤‘ë‹¨, í™•ì„±ê¸° ì² ê±°, í•œë¯¸ì—°í•©í›ˆë ¨ ì¡°ì •, ë¶í•œ ì¸ê¶Œë³´ê³ ì„œ ë°œê°„ ì¤‘ë‹¨ ê²€í† ê¹Œì§€ ì˜¨í†µ ë¶í•œ ê¹€ì •ì€ì´ ì›ƒì„ ì¼ë§Œ ì´ì–´ì¡Œë‹¤â€ê³  í–ˆë‹¤.
ê·¸ëŠ” â€œ9Â·19 êµ°ì‚¬í•©ì˜ëŠ” ë¬¸ì¬ì¸ ì •ë¶€ ë‹¹ì‹œì—ë„ ë¶í•œì´ ë°¥ ë¨¹ë“¯ì´ ìœ„ë°˜í•˜ë©° ì‚¬ì‹¤ìƒ ë¬´ë ¥í™”ëì—ˆëŠ”ë° ì´ë¥¼ ë‹¤ì‹œ ë³µì›í•˜ê² ë‹¤ëŠ” ê²ƒì€ ì´ë¯¸ ì‹¤íŒ¨ë¡œ ì¦ëª…ëœ ì¡±ì‡„ë¥¼ ìš°ë¦¬ ìŠ¤ìŠ¤ë¡œ ë°œëª©ì— ì±„ìš°ê² ë‹¤ëŠ” ê²ƒâ€ì´ë¼ë©° â€œí‰í™”ëŠ” í˜ì´ ìˆì„ ë•Œë§Œ ê°€ëŠ¥í•˜ë‹¤ëŠ” ìƒì‹ì„ ì´ ì •ë¶€ë§Œ ëª¨ë¥´ëŠ” ê²ƒì´ëƒ ì•„ë‹ˆë©´ ì•Œê³ ë„ ì™¸ë©´í•˜ëŠ” ê²ƒì´ëƒâ€ë¼ê³  ë§í–ˆë‹¤.
ê¹€ë¬¸ìˆ˜ êµ­ë¯¼ì˜í˜ ë‹¹ëŒ€í‘œ í›„ë³´ë„ í˜ì´ìŠ¤ë¶ì—ì„œ â€œì´ì¬ëª… ëŒ€í†µë ¹ì€ ì§€ê¸ˆ ë¶í•µ ìœ„í—˜, ì˜¤ë¬¼ í’ì„  ì‚´í¬, ëŠì„ì—†ëŠ” ë¬´ë ¥ ë„ë°œì— ë§ì„œì•¼ í•  ì‹œì ì— ë¶í•œ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì ëŒ€ í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤ëŠ” êµ´ë³µ ì„ ì–¸ì„ í–ˆë‹¤â€ë©° â€œ9Â·19 êµ°ì‚¬í•©ì˜ë¥¼ ë¨¼ì € ê¹¬ ìª½ë„ ë¶í•œì¸ë° ì™œ ìš°ë¦¬ê°€ ë¶í•œì— ê³ ê°œë¥¼ ìˆ™ì—¬ì•¼ í•˜ë‚˜â€ë¼ê³  ë¹„íŒí–ˆë‹¤.
ê·¸ëŠ” â€œê¹€ì •ì€ì˜ ëŒ€ë³€ì¸ì´ ì•„ë‹ˆë¼ë©´ ê²°ì½” ë‚˜ì˜¬ ìˆ˜ ì—†ëŠ” ë°œì–¸â€ì´ë¼ë©° â€œëŒ€í†µë ¹ì˜ ìë¦¬ëŠ” ê¹€ì •ì€ì˜ ì‹¬ê¸°ë¥¼ ì‚´í”¼ëŠ” ìë¦¬ê°€ ì•„ë‹ˆë¼ ì˜¤ì§ ëŒ€í•œë¯¼êµ­ì˜ ì•ˆìœ„ë¥¼ ì§€í‚¤ê¸° ìœ„í•´ ìµœì„ ì„ ë‹¤í•´ì•¼ í•˜ëŠ” ìë¦¬â€ë¼ê³  ë§í–ˆë‹¤.
ì´ ëŒ€í†µë ¹ì€ ì§€ë‚œ 15ì¼ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ â€œí˜„ì¬ ë¶ì¸¡ì˜ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì–´ë– í•œ í˜•íƒœì˜ í¡ìˆ˜í†µì¼ë„ ì¶”êµ¬í•˜ì§€ ì•Šì„ ê²ƒì´ë©° ì¼ì²´ì˜ ì ëŒ€í–‰ìœ„ë¥¼ í•  ëœ»ë„ ì—†ìŒì„ ë¶„ëª…íˆ ë°íŒë‹¤â€ê³  ë§í–ˆë‹¤.
---
ë‰´ìŠ¤2 :
êµ­ë¯¼ì˜í˜ì€ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ êµ­ë¯¼ì„ëª…ì‹ì—ì„œ ë‚­ë…í•œ â€˜êµ­ë¯¼ê»˜ ë“œë¦¬ëŠ” í¸ì§€â€™ì— ëŒ€í•´ â€œêµ­ë¯¼ì„ í˜„í˜¹í•˜ëŠ” ë§ë¡œ ì ì² ëœ ê±°ì§“ë§ì˜ í–¥ì—°â€ì´ë¼ê³  í˜¹í‰í–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì„ í†µí•´ â€œì´ ëŒ€í†µë ¹ì´ ì´ì•¼ê¸°í•˜ëŠ” êµ­ë¯¼ì€ ë„ëŒ€ì²´ ëˆ„êµ¬ë¥¼ ë§í•˜ëŠ” ê²ƒì´ëƒâ€ë¼ë©° ì´ê°™ì´ ë°í˜”ë‹¤.
ìµœ ëŒ€ë³€ì¸ì€ â€œì´ ëŒ€í†µë ¹ì€ ê¸°ì—…ì´ ììœ ë¡­ê²Œ ì„±ì¥í•˜ê³  ì„¸ê³„ ì‹œì¥ì—ì„œ ê²½ìŸí•  ìˆ˜ ìˆë„ë¡ ë•ê² ë‹¤ í–ˆì§€ë§Œ, ê¸°ì—…ë“¤ì€ ë¯¸êµ­ë°œ ê´€ì„¸ í­íƒ„ê³¼ ìƒë²• ê°œì•… ë“± â€˜ê¸°ì—… ì˜¥ì£„ê¸°â€™ ì •ì±…ì— ê²½ì˜ í™˜ê²½ì´ ê°ˆìˆ˜ë¡ ì–´ë ¤ì›Œì§€ê³  ìˆë‹¤ê³  í˜¸ì†Œí•œë‹¤â€ê³  ì£¼ì¥í–ˆë‹¤.
ê·¸ëŠ” ì´ì–´ â€˜ê³¼í•™ ê¸°ìˆ ì¸ ì§€ì›â€™ ì•½ì†ì— ëŒ€í•´ì„  â€œ(ë°˜ë„ì²´ íŠ¹ë³„ë²•) 52ì‹œê°„ ê´€ë ¨ ë²•ì•ˆì„ ì´ ëŒ€í†µë ¹ê³¼ ë¯¼ì£¼ë‹¹ì´ ê²°ì‚¬ë°˜ëŒ€í–ˆë˜ ëª¨ìŠµë§Œ ë´ë„ ì´ëŠ” í—ˆêµ¬ì— ê°€ë“ ì°¬ ê±°ì§“ë§â€ì´ë¼ê³  ë¹„íŒí–ˆë‹¤.
ê·¸ëŸ¬ë©´ì„œ â€œì¡°êµ­ê³¼ ìœ¤ë¯¸í–¥ ì‚¬ë©´ì„ ê°•í–‰í•˜ê³  ëŒ€í†µë ¹ ë³€í˜¸ì¸ë‹¨ì„ â€˜ì²­ë¬¸íšŒ ì—†ëŠ” ìš”ì§â€™ì— ì•‰íˆëŠ” ë“± êµ­ë¯¼ì´ ì•„ë‹Œ ì˜¤ì§ ìš°ë¦¬ í¸ë§Œì„ ì±™ê¸°ëŠ” ì§„ì˜ì˜ ëŒ€ë³€ìê°€ ë” ì–´ìš¸ë¦¬ëŠ” í‘œí˜„ì¼ ê²ƒâ€ì´ë¼ê³  ë§ë¶™ì˜€ë‹¤.
í˜¸ì¤€ì„ ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ ì´ ëŒ€í†µë ¹ì´ ë¯¸êµ­ ë°©ë¬¸ì— ì•ì„œ ì¼ë³¸ì„ ì°¾ì•„ í•œÂ·ì¼ ì •ìƒíšŒë‹´ì„ í•˜ëŠ” ê²ƒì„ ë‘ê³  â€œ2023ë…„ ì…”í‹€ ì™¸êµê°€ ë³µì›ë˜ì ì´ì¬ëª… ë‹¹ì‹œ ë¯¼ì£¼ë‹¹ ëŒ€í‘œëŠ” â€˜ì¹œì¼ì„ ë„˜ì–´ ìˆ­ì¼â€™ì´ë¼ê³  ëª°ì•„ì„¸ì› ë‹¤â€ë©° â€œêµ­ê°€ì˜ ì§€ë„ìë¼ë©´ ë¶ˆê³¼ 2ë…„ì „ ìê¸° ë§ê³¼ í–‰ë™ì— ëŒ€í•´ ì±…ì„ì§€ê³  ìœ ê° í‘œëª…ì´ë¼ë„ í•´ì•¼ í•œë‹¤â€ê³  ë§í–ˆë‹¤.
---
ë‰´ìŠ¤3 :
êµ­ë¯¼ì˜í˜ì€ 16ì¼ ì´ì¬ëª… ëŒ€í†µë ¹ì´ ê´‘ë³µì ˆ ê²½ì¶•ì‚¬ì—ì„œ ë¶í•œì„ ë¶ì¸¡ì´ë¼ê³  ë¶€ë¥´ë©° â€œëŒ€í™”ë¥¼ ë³µì›í•˜ëŠ” ê¸¸ì— ë¶ì¸¡ì´ í™”ë‹µí•˜ê¸¸ ì¸ë‚´í•˜ë©´ì„œ ê¸°ëŒ€í•˜ê² ë‹¤â€ê³  ì–¸ê¸‰í•œ ê²ƒì— ëŒ€í•´ â€œë¶í•œì— ëŒ€í•œ ë¬´í•œ ì¸ë‚´ê°€ ì•„ë‹ˆë¼ êµ­ë¯¼ ì¸ë‚´ì‹¬ì„ ì‹œí—˜í•˜ê³  ìˆë‹¤â€ê³  ë¹„íŒí–ˆë‹¤.
ìµœì€ì„ êµ­ë¯¼ì˜í˜ ìˆ˜ì„ëŒ€ë³€ì¸ì€ ì´ë‚  ë…¼í‰ì—ì„œ â€œëŒ€í†µë ¹ ì·¨ì„ ì´í›„ ì´ ì •ë¶€ê°€ ê±¸ì–´ì˜¨ ëŒ€ë¶ í–‰ë³´ë¥¼ ë³´ë©´ ì˜¨í†µ ë¶í•œ ê¹€ì •ì€ì´ ì›ƒì„ ì¼ë§Œ ì´ì–´ì¡Œë‹¤â€ë©° â€œë¶í•œì´ â€˜í—ˆë§í•œ ê°œê¿ˆâ€™ì´ë¼ ì¡°ë¡±í•˜ëŠ” ìƒí™©ì—ì„œë„ ëê¹Œì§€ í™”ë‹µì„ ê¸°ëŒ€í•œë‹¤ê³  í•œë‹¤â€ê³  ì§€ì í–ˆë‹¤.
ì´ì–´ ì´ ëŒ€í†µë ¹ì´ ë¶í•œì— â€œì¼ì²´ì˜ ì ëŒ€í–‰ìœ„ë¥¼ í•  ëœ»ì´ ì—†ë‹¤â€ê³  ë§í•œ ê²ƒê³¼ ê´€ë ¨ â€œë¨¸ë¦¬ì— í•µì„ ì¸ ì±„ â€˜ì ëŒ€ í–‰ìœ„ëŠ” í•˜ì§€ ì•Šê² ë‹¤â€™ëŠ” ì„ ì–¸ì€ í˜„ì‹¤ì„ ì™¸ë©´í•œ í•œê°€í•œ ì†Œë¦¬ì¼ ë¿â€ì´ë¼ê³  ë§í–ˆë‹¤.
ë˜ â€œêµ­ë¯¼ì´ ì •ì‘ ë“£ê³  ì‹¶ì–´ í–ˆë˜ ê²ƒì€ ë¶í•œì˜ í•µÂ·ë¯¸ì‚¬ì¼ ìœ„í˜‘ê³¼ ë„ë°œì— ëŒ€í•œ ë‹¨í˜¸í•œ ê²½ê³ ì™€ ê·¸ì— ë§ì„¤ ê°•ë ¥í•œ ì–µì§€ë ¥ ê°•í™” ë°©ì•ˆì´ë‹¤. í‰í™”ëŠ” êµ¬ê±¸ì´ ì•„ë‹ˆë¼ ê°•í•œ ì–µì§€ë ¥ì—ì„œ ë‚˜ì˜¨ë‹¤â€ê³  ê°•ì¡°í–ˆë‹¤.
ìµœ ìˆ˜ì„ëŒ€ë³€ì¸ì€ â€œ9Â·19 êµ°ì‚¬í•©ì˜ë¥¼ ë‹¤ì‹œ ë³µì›í•˜ê² ë‹¤ëŠ” ê²ƒì€ ì´ë¯¸ ì‹¤íŒ¨ë¡œ ì¦ëª…ëœ ì¡±ì‡„ë¥¼ ìš°ë¦¬ ìŠ¤ìŠ¤ë¡œ ë°œëª©ì— ì±„ìš°ê² ë‹¤ëŠ” ê²ƒìœ¼ë¡œ, ìë©¸ë¡œ ê°€ëŠ” ê¸¸â€ì´ë¼ê³  ë§í–ˆë‹¤.
ë‹¹ ëŒ€í‘œ í›„ë³´ì¸ ê¹€ë¬¸ìˆ˜ í›„ë³´ë„ ì…ì¥ë¬¸ì„ í†µí•´ â€œì´ ëŒ€í†µë ¹ì´ ë¶í•œ ì²´ì œë¥¼ ì¡´ì¤‘í•˜ê³  ì ëŒ€ í–‰ìœ„ë¥¼ í•˜ì§€ ì•Šê² ë‹¤ëŠ” êµ´ë³µ ì„ ì–¸ì„ í–ˆë‹¤â€ë©° â€œê¹€ì •ì€ì˜ ëŒ€ë³€ì¸ì´ ì•„ë‹ˆë¼ë©´ ê²°ì½” ë‚˜ì˜¬ ìˆ˜ ì—†ëŠ” ë°œì–¸â€ì´ë¼ê³  ë¹„íŒí–ˆë‹¤.
"""


import streamlit as st
from langchain_openai import ChatOpenAI
from dotenv import load_dotenv
from langchain_teddynote.prompts import load_prompt
import os
import re

from pydub import AudioSegment
from openai import OpenAI
import io
import re

from core import (
    run_host_agent,
    run_guest_agents,
    run_writer_agent,
    generate_clova_speech,
)

load_dotenv(dotenv_path=".env")

LANGSMITH_API_KEY = os.getenv("LANGSMITH_API_KEY")

# title
st.title("ğŸ¤ AI ë‰´ìŠ¤ íŒŸìºìŠ¤íŠ¸ ìŠ¤íŠœë””ì˜¤")
st.markdown(
    "ê´€ì‹¬ ìˆëŠ” ë‰´ìŠ¤ ê¸°ì‚¬ë¥¼ ê²€ìƒ‰í•˜ê³ , AIê°€ ìë™ìœ¼ë¡œ ëŒ€ë³¸ì„ ì‘ì„±í•˜ì—¬ íŒŸìºìŠ¤íŠ¸ ìŒì„±ê¹Œì§€ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤."
)
# --- ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™” ---
# ëŒ€ë³¸ì„ ì €ì¥í•  ì„¸ì…˜ ìƒíƒœ ì¶”ê°€
if "script" not in st.session_state:
    st.session_state.script = ""
if "podcast_mood" not in st.session_state:
    st.session_state.podcast_mood = "ì°¨ë¶„í•œ"
if "selected_category" not in st.session_state:
    st.session_state.selected_category = "ì „ì²´"
if "selected_language" not in st.session_state:
    st.session_state.selected_language = "í•œêµ­ì–´"


# --- 1. ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ ì„¹ì…˜ ---
st.write("")
st.subheader("1. ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ")

# ë‰´ìŠ¤ ì¹´í…Œê³ ë¦¬ ì„ íƒ ë²„íŠ¼ (ë„¤ëª¨ ë²„íŠ¼ í˜•íƒœë¡œ ê°€ë¡œ ë°°ì¹˜ + ì´ëª¨ì§€)
category_options = {
    "ì „ì²´": "ğŸŒ ì „ì²´",
    "ê²½ì œ": "ğŸ“ˆ ê²½ì œ",
    "IT": "ğŸ’» IT/ê³¼í•™",
    "ì •ì¹˜": "ğŸ›ï¸ ì •ì¹˜",
    "ì‚¬íšŒ": "ğŸ‘¥ ì‚¬íšŒ",
    "ìƒí™œ/ë¬¸í™”": "ğŸ¨ ìƒí™œ/ë¬¸í™”",
    "ìŠ¤í¬ì¸ ": "âš½ ìŠ¤í¬ì¸ ",
    "ì„¸ê³„": "ğŸŒ ì„¸ê³„",
}

num_cols_per_row = 4
cols = st.columns(num_cols_per_row)
col_idx = 0

for i, (cat_key, cat_label) in enumerate(category_options.items()):
    with cols[col_idx]:
        button_type = (
            "primary" if st.session_state.selected_category == cat_key else "secondary"
        )

        if st.button(
            cat_label,
            key=f"cat_btn_{cat_key}",
            use_container_width=True,
            type=button_type,
        ):

            if st.session_state.selected_category != cat_key:
                st.session_state.selected_category = cat_key
                # ì„¸ì…˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•œ í›„ ì•±ì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ UIë¥¼ ì¦‰ì‹œ ê°±ì‹ 
                st.rerun()
    col_idx = (col_idx + 1) % num_cols_per_row

# ì‚¬ì´ë“œë°” ìƒì„±

# --- 2. ë‰´ìŠ¤ ê²€ìƒ‰ ì¡°ê±´ ì…ë ¥ ì„¹ì…˜ ---
st.write("")
st.subheader("2. ë‰´ìŠ¤ ê²€ìƒ‰ ì¡°ê±´ ì…ë ¥")
query = st.text_input(
    "ê²€ìƒ‰í•  ë‰´ìŠ¤ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 'ì¸ê³µì§€ëŠ¥ AND ì¼ìë¦¬', 'ê¸°í›„ë³€í™” OR íƒ„ì†Œì¤‘ë¦½')",
    placeholder="ì˜ˆ: 'ì±—GPT', 'ê²½ì œ ì¹¨ì²´'",
)

# --- 3. íŒŸìºìŠ¤íŠ¸ ë¶„ìœ„ê¸° ì„ íƒ ì„¹ì…˜ ---
st.write("")
st.subheader("3. íŒŸìºìŠ¤íŠ¸ ë¶„ìœ„ê¸° ì„ íƒ")

# íŒŸìºìŠ¤íŠ¸ ë¶„ìœ„ê¸° ì„ íƒ ë²„íŠ¼ (ë„¤ëª¨ ë²„íŠ¼ í˜•íƒœë¡œ ê°€ë¡œ ë°°ì¹˜ + ì´ëª¨ì§€)
mood_options = {
    "ì°¨ë¶„í•œ": "ğŸ§˜â€â™€ï¸ ì°¨ë¶„í•œ",
    "ì‹ ë‚˜ëŠ”": "ğŸ¥³ ì‹ ë‚˜ëŠ”",
    "ì „ë¬¸ì ì¸": "ğŸ‘¨â€ğŸ« ì „ë¬¸ì ì¸",
    "ìœ ë¨¸ëŸ¬ìŠ¤í•œ": "ğŸ˜‚ ìœ ë¨¸ëŸ¬ìŠ¤í•œ",
}
cols = st.columns(len(mood_options))


for i, (mood_key, mood_label) in enumerate(mood_options.items()):
    with cols[i]:
        # ì„ íƒëœ ë¶„ìœ„ê¸° ë²„íŠ¼ì€ primary typeìœ¼ë¡œ í‘œì‹œ
        button_type = (
            "primary" if st.session_state.podcast_mood == mood_key else "secondary"
        )
        if st.button(
            mood_label,  # ì´ëª¨ì§€ì™€ í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì „ë‹¬
            key=f"mood_btn_{mood_key}",
            use_container_width=True,
            type=button_type,
        ):
            st.session_state.podcast_mood = mood_key

# --- 4. íŒŸìºìŠ¤íŠ¸ ì–¸ì–´ ì„ íƒ ì„¹ì…˜ (ìƒˆë¡œ ì¶”ê°€) ---
st.write("")
st.subheader("4. íŒŸìºìŠ¤íŠ¸ ì–¸ì–´ ì„ íƒ")

language_options = {"í•œêµ­ì–´": "ğŸ‡°ğŸ‡· í•œêµ­ì–´", "ì˜ì–´": "ğŸ‡ºğŸ‡¸ ì˜ì–´", "ì¤‘êµ­ì–´": "Ch ì¤‘êµ­ì–´"}
lang_cols = st.columns(len(language_options))

for i, (lang_key, lang_label) in enumerate(language_options.items()):
    with lang_cols[i]:
        button_type = (
            "primary" if st.session_state.selected_language == lang_key else "secondary"
        )
        if st.button(
            lang_label,
            key=f"lang_btn_{lang_key}",
            use_container_width=True,
            type=button_type,
        ):
            st.session_state.selected_language = lang_key

# --- 5. íŒŸìºìŠ¤íŠ¸ ìƒì„± ë²„íŠ¼ ì„¹ì…˜ ---
st.write("")
st.subheader("5. íŒŸìºìŠ¤íŠ¸ ìƒì„±")

if st.button(
    "âœ¨ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸ ìƒì„± ë° ìŒì„± ë§Œë“¤ê¸°", use_container_width=True, type="primary"
):
    if not query:
        st.error("ë‰´ìŠ¤ ê²€ìƒ‰ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        try:
            llm = ChatOpenAI(model_name="gpt-4o", temperature=0.7)

            with st.spinner(
                "1/3ë‹¨ê³„: Host-Agentê°€ ê²ŒìŠ¤íŠ¸ë¥¼ ì„­ì™¸í•˜ê³  ì§ˆë¬¸ì§€ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤..."
            ):
                host_response = run_host_agent(llm, query, content)
                guests = host_response["guests"]
                interview_outline = host_response["interview_outline"]
                st.session_state.guests = guests  # ì„¸ì…˜ì— ê²ŒìŠ¤íŠ¸ ì •ë³´ ì €ì¥

            with st.spinner(
                "2/3ë‹¨ê³„: Guest-Agentsê°€ ê°ìì˜ ì „ë¬¸ ë¶„ì•¼ì— ë§ì¶° ë‹µë³€ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤..."
            ):
                guest_answers = run_guest_agents(llm, query, guests, interview_outline, content)

            with st.spinner(
                "3/3ë‹¨ê³„: Writer-Agentê°€ ìˆ˜ì§‘ëœ ë‹µë³€ë“¤ì„ ë§›ê¹”ë‚˜ëŠ” ëŒ€í™” ëŒ€ë³¸ìœ¼ë¡œ ë‹¤ë“¬ê³  ìˆìŠµë‹ˆë‹¤..."
            ):
                final_script = run_writer_agent(
                    llm,
                    query,
                    st.session_state.podcast_mood,
                    st.session_state.selected_language,
                    guests,
                    guest_answers,
                )
                st.session_state.script = final_script

        except Exception as e:
            st.error(f"ëŒ€ë³¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

# app.py íŒŒì¼ì— ì¶”ê°€ë  ë‚´ìš©

st.write("")
# --- 6. ìƒì„±ëœ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸ ë° ìŒì„± ìƒì„± UI ---
st.subheader("6. ìƒì„±ëœ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸ ë° ìŒì„±")

# st.session_stateì— 'script'ê°€ ìƒì„±ë˜ì—ˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
if "script" in st.session_state and st.session_state.script:
    final_script = st.session_state.script

    # ìƒì„±ëœ ëŒ€ë³¸ì„ UIì— í‘œì‹œ
    st.text_area("ìƒì„±ëœ íŒŸìºìŠ¤íŠ¸ ëŒ€ë³¸", final_script, height=300)

    # --- 1ë‹¨ê³„ (ì¤€ë¹„): ëŒ€ë³¸ì—ì„œ í™”ì ëª©ë¡ ì¶”ì¶œ ---
    lines = re.split(r"\n(?=[\w\s]+:)", final_script.strip())
    parsed_lines = []
    for line in lines:
        if ":" in line:
            speaker, text = line.split(":", 1)
            parsed_lines.append({"speaker": speaker.strip(), "text": text.strip()})

    # ê³ ìœ í•œ í™”ì ëª©ë¡ì„ ìˆœì„œëŒ€ë¡œ ì •ë ¬í•˜ì—¬ ì¶”ì¶œ
    speakers = sorted(list(set([line["speaker"] for line in parsed_lines])))

    # --- 2ë‹¨ê³„ (UI): í™”ìë³„ ëª©ì†Œë¦¬ ì„ íƒ UI í‘œì‹œ ---
    st.write("---")
    st.subheader("ğŸ¤ í™”ìë³„ ëª©ì†Œë¦¬ ì„¤ì •")

    # ì‚¬ìš© ê°€ëŠ¥í•œ ëª©ì†Œë¦¬ ëª©ë¡
    available_voices = [
        "nara",
        "dara",
        "jinho",
        "nhajun",
        "nsujin",
        "nsiyun",
        "njihun",
    ]  # ì˜ˆì‹œ ëª©ë¡

    # ê° í™”ìì— ëŒ€í•œ ëª©ì†Œë¦¬ ì„ íƒ ë©”ë‰´ë¥¼ ìƒì„±
    # st.columnsë¥¼ ì‚¬ìš©í•´ 2ì—´ë¡œ ê¹”ë”í•˜ê²Œ ë°°ì¹˜
    cols = st.columns(2)
    for i, speaker in enumerate(speakers):
        with cols[i % 2]:
            st.selectbox(
                label=f"**{speaker}**ì˜ ëª©ì†Œë¦¬ ì„ íƒ",
                options=available_voices,
                key=f"voice_select_{speaker}",  # ê° ë©”ë‰´ë¥¼ êµ¬ë¶„í•˜ê¸° ìœ„í•œ ê³ ìœ  í‚¤
            )

    st.write("---")

    # --- 3ë‹¨ê³„ (ì‹¤í–‰): 'ìŒì„± ë§Œë“¤ê¸°' ë²„íŠ¼ ë° ë¡œì§ ---
    if st.button(
        "ì´ ëŒ€ë³¸ê³¼ ì„¤ì •ìœ¼ë¡œ íŒŸìºìŠ¤íŠ¸ ìŒì„± ë§Œë“¤ê¸° ğŸ§",
        use_container_width=True,
        type="primary",
    ):
        with st.spinner(
            "ğŸ§ íŒŸìºìŠ¤íŠ¸ ìŒì„±ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... (ê¸´ ëŒ€ì‚¬ëŠ” ë¶„í•  ì²˜ë¦¬ë©ë‹ˆë‹¤)"
        ):
            # 'ì´ ëŒ€ë³¸ê³¼ ì„¤ì •ìœ¼ë¡œ íŒŸìºìŠ¤íŠ¸ ìŒì„± ë§Œë“¤ê¸° ğŸ§' ë²„íŠ¼ ë¡œì§ ì „ì²´
            try:
                # --- (ì´ì „ ì½”ë“œì™€ ë™ì¼) ì‚¬ìš©ì ì„ íƒìœ¼ë¡œ voice_map ìƒì„± ---
                voice_map = {}
                for speaker in speakers:
                    voice_map[speaker] = st.session_state[f"voice_select_{speaker}"]

                # --- 1. ëª¨ë“  ìŒì„± ì¡°ê°ì„ ìƒì„±í•´ì„œ 'audio_segments' ë¦¬ìŠ¤íŠ¸ì— ëª¨ìœ¼ê¸° ---
                audio_segments = []
                for line in parsed_lines:
                    speaker = line["speaker"]
                    full_text = line["text"]
                    clova_speaker = voice_map.get(speaker, "nara")

                    if not full_text.strip():
                        continue

                    # í…ìŠ¤íŠ¸ ë¶„í• (Chunking) ë¡œì§
                    text_chunks = []
                    if len(full_text) > 2000:
                        sentences = re.split(r"(?<=[.!?])\s+", full_text)
                        current_chunk = ""
                        for sentence in sentences:
                            if len(current_chunk) + len(sentence) + 1 < 2000:
                                current_chunk += sentence + " "
                            else:
                                text_chunks.append(current_chunk.strip())
                                current_chunk = sentence + " "
                        if current_chunk:
                            text_chunks.append(current_chunk.strip())
                    else:
                        text_chunks.append(full_text)

                    # ê° í…ìŠ¤íŠ¸ ì¡°ê°ì— ëŒ€í•´ ìŒì„±ì„ ìƒì„±í•˜ê³  ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                    for text in text_chunks:
                        audio_content, error = generate_clova_speech(
                            text=text, speaker=clova_speaker
                        )

                        if error:
                            st.error(error)
                            st.stop()

                        audio_bytes = io.BytesIO(audio_content)
                        segment = AudioSegment.from_file(audio_bytes, format="mp3")
                        audio_segments.append(segment)

                # â–¼â–¼â–¼ 2. ëª¨ë“  for ë£¨í”„ê°€ ëë‚œ í›„ì—, ë”± í•œ ë²ˆë§Œ ìŒì„± ë³‘í•© ë° ì¶œë ¥! â–¼â–¼â–¼

                # ìŒì„± íŒŒì¼ ë³‘í•©
                pause = AudioSegment.silent(duration=500)
                final_podcast = AudioSegment.empty()
                for segment in audio_segments:
                    final_podcast += segment + pause

                # ìµœì¢… íŒŒì¼ ì¶œë ¥
                final_podcast_io = io.BytesIO()
                final_podcast.export(final_podcast_io, format="mp3")
                final_podcast_io.seek(0)

                st.success("ğŸ‰ íŒŸìºìŠ¤íŠ¸ ìŒì„± ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
                st.audio(final_podcast_io, format="audio/mp3")

                st.download_button(
                    label="ğŸ§ MP3 íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                    data=final_podcast_io,
                    file_name="podcast.mp3",
                    mime="audio/mpeg",
                )
                # â–²â–²â–² ì´ ë¡œì§ì´ ë£¨í”„ ë°”ê¹¥ìœ¼ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤ â–²â–²â–²

            except Exception as e:
                st.error(f"ìŒì„± ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
